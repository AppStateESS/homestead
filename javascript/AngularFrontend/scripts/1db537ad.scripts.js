"use strict";angular.module("roomDamages",[]),angular.module("hmsAngularApp",["ngResource","roomDamages","ngRoute"]).config(["$routeProvider","$httpProvider",function(a,b){b.defaults.useXDomain=!0,b.defaults.withCredentials=!0,a.when("/",{templateUrl:"views/checkout.html",controller:"CheckoutCtrl"}).otherwise({redirectTo:"/"})}]);var myApp=angular.module("hmsAngularApp");myApp.controller("CheckoutCtrl",["$scope","roomDamageBroker","roomDamageResident","roomDamageType","$http",function(a,b,c,d,e){b.getDamages().then(function(b){a.damages=b.data}),a.dmgTypes=d,a.newDamages=[],a.residents=c.getResidents(),a.student=c.getStudent(),a.assignment=c.getAssignment(),a.checkin=c.getCheckin(),a.addDamage=function(){var b=angular.copy(a.residents);a.newDamages.push({residents:b})},a.removeDamage=function(b){a.newDamages.splice(b,1)},a.data={},a.data.keyCode="",a.data.keyReturned=-1,a.data.properCheckout=-1,a.data.improperCheckoutNote="",a.triedSubmit=!1;var f=function(){a.checkout_form.keyCode.$setValidity("keyReturn",1!=a.data.keyReturned||!!a.data.keyCode),a.checkout_form.keyReturned.$setValidity("keyReturn",-1!=a.data.keyReturned)};a.$watch("data.keyReturned",f),a.$watch("data.keyCode",f);var g=function(){a.checkout_form.properCheckout.$setValidity("properCheckout",-1!=a.data.properCheckout)};a.$watch("data.properCheckout",g),a.submitHandler=function(){a.triedSubmit=!0;for(var c=0;c<a.newDamages.length;c++){var d=!1;for(var f in a.newDamages[c].residents)a.newDamages[c].residents[f].selected&&(d=!0);if(!d)return void alert("Please select at least one student who is responsible for each damage.")}if(!a.checkout_form.$valid)return void alert("Cannot complete checkout because the form is incomplete.  Please check the form for errors.");var g=b.getBaseLocation();e.post(g+"?module=hms&action=CheckoutFormSubmit&ajax=true",{bannerId:a.student.studentId,checkinId:a.checkin.id,keyCode:a.data.keyCode,keyReturned:a.data.keyReturned,newDamages:a.newDamages,properCheckout:a.data.properCheckout,improperCheckoutNote:a.data.improperCheckoutNote}).success(function(a,b,c){window.location=c("location")}).error(function(){alert("Something went wrong while saving this checkout. Please contact the Housing Assignments Office.")})}}]);var myApp=angular.module("hmsAngularApp");myApp.controller("RoomDamageAssessmentCtrl",["$scope","roomDamageType","roomDamageAssessment",function(a,b,c){c.getDamages().then(function(b){a.assessment={rooms:b.data}}),a.damageTypes=b,a.sumAmounts=function(a){if(a){var b=0;for(var c in a)a[c]&&a[c].amount&&(b+=Number(a[c].amount));return b.toFixed(2)}},a.submitDamage=function(a){a.submitted="saving";var b=[];for(var d in a.damages)for(var e in a.damages[d].responsibilities)b.push(a.damages[d].responsibilities[e]);c.postResponsibilities(b).success(function(){a.submitted="success"}).error(function(){a.submitted="failure"})},a.splitEvenly=function(b){var c=b.responsibilities.length,d=a.damageTypes[b.damage_type].cost/c;for(var e in b.responsibilities)b.responsibilities[e].amount=d.toFixed(2)}}]),angular.module("roomDamages").provider("roomDamageBroker",function(){function a(a,c){this.getDamages=function(){return a.get(b+"?module=hms&ajax=true&action=GetRoomDamages&bed_id="+c)},this.getBaseLocation=function(){return b}}var b=null;this.setLocation=function(a){b=a},this.$get=["$http","roomDamageResident",function(b,c){return new a(b,c.getCheckin().bed_id)}]}),angular.module("roomDamages").provider("roomDamageAssessment",function(){var a=null;this.setLocation=function(b){a=b};var b=null;this.setTerm=function(a){b=a};var c=function(b,c){this.getDamages=function(){return b.get(a+"?module=hms&ajax=true&action=GetRoomDamagesToAssess&term="+c)},this.postResponsibilities=function(c){return b.post(a+"?module=hms&action=AssessRoomDamage&ajax=true",{responsibilities:c})}};this.$get=["$http",function(a){return new c(a,b)}]}),angular.module("roomDamages").provider("roomDamageResident",function(){function a(){this.getResidents=function(){return b},this.getStudent=function(){return c},this.getAssignment=function(){return d},this.getCheckin=function(){return e}}var b=null,c=null,d=null,e=null;this.setResidents=function(a){b=a},this.setStudent=function(a){c=a},this.setAssignment=function(a){d=a},this.setCheckin=function(a){e=a},this.$get=function(){return new a}}),angular.module("roomDamages").provider("roomDamageType",function(){var a=null;this.setDamageTypes=function(b){a=b},this.getDamageTypes=function(){return a},this.$get=function(){return a}});var myApp=angular.module("hmsAngularApp");myApp.directive("dollars",function(){return{require:"ngModel",link:function(a,b,c,d){var e=/^(?:[0-9]+(?:\.(?:[0-9](?:[0-9])?)?)?)?$/,f=(a.$eval(c.ngModel),!1);a.$watch(c.ngModel,function(b,g){d.$setValidity("dollars",!!b&&e.test(b)),f||null!=b&&(e.test(b)||(f=!0,a.$eval(c.ngModel+" = "+angular.toJson(g)),setTimeout(function(){f=!1},0)))})}}});